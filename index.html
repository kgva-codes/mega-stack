<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mega Stack</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAAOklEQVR42mNgGAU0A8ZGRj4YGBgkQETAwMAQTAwMDCxMTEwMDCyMjAwGkAAAwB0Xgk+IbLJzAAAAABJRU5ErkJggg==" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fff;
      color: #000;
      padding: 40px;
      max-width: 900px;
      margin: auto;
    }

    h1 {
      font-size: 36px;
      border-bottom: 2px solid #000;
      padding-bottom: 10px;
    }

    #question-box {
      margin-top: 30px;
    }

    #question-label {
      font-weight: bold;
      font-size: 18px;
      display: block;
      margin-bottom: 12px;
    }

    #answer-box {
      width: 100%;
      height: 180px;
      font-size: 16px;
      padding: 12px;
      box-sizing: border-box;
    }

    .shortcuts {
      margin-top: 12px;
      font-size: 14px;
      color: #333;
    }

    .nav-buttons {
      margin-top: 20px;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      background: #000;
      color: #fff;
      border: none;
      cursor: pointer;
      margin-right: 10px;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>

<body>

<h1>Mega Stack</h1>

<div id="question-box">
  <span id="question-label"></span>
  <textarea id="answer-box"></textarea>

  <div class="shortcuts">
    <strong>Keyboard shortcuts:</strong><br>
    Ctrl / Cmd + Enter → Next question<br>
    Ctrl / Cmd + ← → Previous question<br>
    Ctrl / Cmd + S → Finish & Save PDF
  </div>

  <div class="nav-buttons">
    <button id="back-btn">Back</button>
    <button id="next-btn">Next</button>
    <button id="save-btn">Finish & Save</button>
  </div>
</div>

<script>
  const questions = [
    "What is the title of this Mega Stack?",
    "Which CORE 4 domain are you stacking?",
    "Who or what is the person or situation involved?",
    "What triggered you?",
    "What is the ORIGINAL story you are telling yourself?",
    "Is this story true?",
    "Are you 100% certain it is true?",
    "How do you react when you believe this story?",
    "What does this story cost you?",
    "Who would you be without this story?",
    "What is your ME story?",
    "Will the ME story give you what you want?",
    "What is the OPPOSITE story?",
    "Will the opposite story give you what you want?",
    "What is the DESIRED story?",
    "Will the desired story give you what you want?",
    "Which version of the story are you choosing?"
  ];

  let current = 0;
  const answers = Array(questions.length).fill("");

  const vars = {
    stackTitle: "",
    core4: "",
    person: "",
    chosenStory: ""
  };

  const labelEl = document.getElementById("question-label");
  const boxEl = document.getElementById("answer-box");
  const nextBtn = document.getElementById("next-btn");
  const backBtn = document.getElementById("back-btn");
  const saveBtn = document.getElementById("save-btn");

  function syncVarsFromAnswers() {
    vars.stackTitle = answers[0] || "";
    vars.core4 = answers[1] || "";
    vars.person = answers[2] || "";
    vars.chosenStory = answers[answers.length - 1] || "";
  }

  function fillTemplate(text) {
    return text
      .replace(/{{STACK_TITLE}}/g, vars.stackTitle)
      .replace(/{{CORE4}}/g, vars.core4)
      .replace(/{{PERSON}}/g, vars.person)
      .replace(/{{CHOSEN_VERSION}}/g, vars.chosenStory);
  }

  function renderQuestion() {
    syncVarsFromAnswers();
    labelEl.textContent = `Q${current + 1}/${questions.length}: ${fillTemplate(questions[current])}`;
    boxEl.value = answers[current];
    backBtn.disabled = current === 0;
    nextBtn.disabled = current === questions.length - 1;
    boxEl.focus();
  }

  nextBtn.onclick = () => {
    answers[current] = boxEl.value;
    if (current < questions.length - 1) current++;
    renderQuestion();
  };

  backBtn.onclick = () => {
    answers[current] = boxEl.value;
    if (current > 0) current--;
    renderQuestion();
  };

  saveBtn.onclick = savePDF;

  document.addEventListener("keydown", e => {
    if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
      e.preventDefault();
      nextBtn.click();
    }
    if ((e.ctrlKey || e.metaKey) && e.key === "ArrowLeft") {
      e.preventDefault();
      backBtn.click();
    }
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s") {
      e.preventDefault();
      savePDF();
    }
  });

  function savePDF() {
    answers[current] = boxEl.value;
    syncVarsFromAnswers();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "letter" });

    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 54;
    const contentWidth = pageWidth - margin * 2;
    const lineHeight = 14;
    const blockGap = 12;

    const dateStr = new Date().toISOString().split("T")[0];

    let y = margin;
    let pageNum = 1;

    function drawHeaderOnce() {
      if (pageNum !== 1) return;

      doc.setFont("helvetica", "bold");
      doc.setFontSize(28);
      doc.text("Mega Stack", margin, y);
      y += 30;

      doc.setFontSize(12);
      doc.text(`Title: ${vars.stackTitle}`, margin, y);
      y += 16;
      doc.text(`Date: ${dateStr}`, margin, y);
      y += 16;
      doc.text(`CORE 4: ${vars.core4}`, margin, y);
      y += 16;
      doc.text(`Person: ${vars.person}`, margin, y);
      y += 20;

      doc.line(margin, y, pageWidth - margin, y);
      y += 20;
    }

    function addPageNoHeader() {
      doc.addPage();
      pageNum++;
      y = margin;
    }

    drawHeaderOnce();

    for (let i = 0; i < questions.length; i++) {
      const q = `${i + 1}. ${fillTemplate(questions[i])}`;
      const a = answers[i] || "";

      const qLines = doc.splitTextToSize(q, contentWidth);
      const aLines = doc.splitTextToSize(a, contentWidth);

      const needed =
        (qLines.length + Math.max(aLines.length, 1)) * lineHeight + blockGap;

      if (y + needed > pageHeight - margin) {
        addPageNoHeader();
      }

      doc.setFont("helvetica", "bold");
      doc.text(qLines, margin, y);
      y += qLines.length * lineHeight;

      doc.setFont("helvetica", "normal");
      doc.text(aLines.length ? aLines : [""], margin, y);
      y += Math.max(aLines.length, 1) * lineHeight + blockGap;
    }

    doc.save(`mega_stack_${vars.stackTitle || "stack"}_${dateStr}.pdf`);
  }

  renderQuestion();
</script>

</body>
</html>
