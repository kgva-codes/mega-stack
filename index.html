<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mega Stack</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fff;
      color: #000;
      padding: 40px;
      max-width: 800px;
      margin: auto;
    }
    h1 {
      border-bottom: 1px solid #000;
      padding-bottom: 0.2em;
    }
    #question-box {
      margin-top: 40px;
    }
    #question-label {
      font-weight: bold;
      margin-bottom: 20px;
      display: block;
    }
    #answer-box {
      width: 100%;
      padding: 10px;
      font-size: 1em;
      margin-bottom: 20px;
      height: 120px;
    }
    .nav-buttons button {
      padding: 10px 20px;
      font-size: 1em;
      margin-right: 10px;
      background: #000;
      color: #fff;
      border: none;
      cursor: pointer;
    }
      #keyboard-hints {
      margin-top: -8px;
      margin-bottom: 18px;
      font-size: 13px;
      color: #444;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <h1>Mega Stack</h1>
  <div id="question-box">
    <span id="question-label"></span>
    <textarea id="answer-box"></textarea>
    <div id="keyboard-hints">
      <strong>Keyboard shortcuts:</strong><br>
      Ctrl / Cmd + Enter → Next question<br>
      Ctrl / Cmd + ← → Previous question<br>
      Ctrl / Cmd + S → Finish &amp; Save PDF
    </div>
    <div class="nav-buttons">
      <button id="back-btn">Back</button>
      <button id="next-btn">Next</button>
      <button id="save-btn">Finish & Save</button>
    </div>
  </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const questions = [
      'What are you going to title this Mega Stack?',
      'What area of the CORE 4 are you triggered by?',
      'Who are you stacking?',
      'What about {{person}} are you stacking?',
      'What feelings best describe your current state of being?',
      'In this moment, why has {{person}} triggered you to feel {{feelings}}?',
      'In this moment, if you could scream at {{person}}, what would you say?',
      'In this moment, if you could force {{person}} to think, say, feel, or do anything, what would it be?',
      'In this moment, with no filter nor constraints, what do you truly think about {{person}}?',
      'In this moment, what is it that you don\'t ever want to experience in the future with {{person}}?',
      'What are the facts about the situation that triggered you?',
      'What is the story, created by the trigger, that you\'re telling yourself and others?',
      'Describe the feelings that arise for you when you tell yourself: "{{originalStory}}".',
      'Describe the specific thoughts or desired actions that arise for you when you tell yourself: "{{originalStory}}".',
      'You said: "{{originalStory}}". What evidence do you have to prove this story is absolutely true?',
      '{{originalStory}}. Is this true?',
      '{{originalStory}}. Are you 100% sure this is true?',
      'What might be possible for you in this situation if this story was false?',
      'Regardless of this emotional trigger with {{person}} and the current story about it, what do you truly want for YOU in this situation?',
      'What do you want for {{person}} in this situation?',
      'What do you want for YOU and {{person}} in this situation?',
      'Your Original Story is "{{originalStory}}". What is the ME Version of your Original Story?',
      'What evidence do you have to prove this ME Version is TRUE?',
      'Your Original Story is "{{originalStory}}". What is the OPPOSITE Version of your Original Story?',
      'What evidence do you have to prove this Opposite Version is TRUE?',
      'Your Original Story is "{{originalStory}}". What is the DESIRED Version of your Original Story?',
      'What evidence do you have to prove this Desired Version is TRUE?',
      'Your Original Story is "{{originalStory}}". What you wanted was: {{whatYouWant}}. Will the ORIGINAL story give you what you want?',
      'Your Me Story is {{meVersion}}. What you wanted was {{whatYouWant}}. Will the ME Version of the story give you what you want?',
      'Your Opposite Story is {{oppositeVersion}}. What you wanted was {{whatYouWant}}. Will the OPPOSITE Version of the story give you what you want?',
      'Your Desired Story is {{desiredVersion}}. What you wanted was {{whatYouWant}}. Will the Desired Story give you what you want?',
      'Now Michael, which version of the story are you choosing? You said you wanted: {{whatYouWant}}. Your Original Story is: {{originalStory}}. Your Me Story is: {{meVersion}}. Your Opposite Story is: {{oppositeVersion}}. Your Desired Story is: {{desiredVersion}}.',
      'Why are you choosing this story?',
      'What triggered you about {{person}} was: "{{triggerDesc}}." You said you wanted: "{{whatYouWant}}." The story you chose is the "{{chosenVersion}}". Why has this trigger been positive?',
      'What is the lesson you learned from this trigger?',
      'How does that lesson apply to your BODY domain?',
      'How does that lesson apply to your BEING domain?',
      'How does that lesson apply to your BALANCE domain?',
      'How does that lesson apply to your BUSINESS domain?',
      'What is the most significant insight or revelation you\'re leaving this stack with?',
      'Why do you feel that this insight or revelation is significant?',
      'What best describes your current state of being?'
    ];

    let current = 0;
    const answers = Array(questions.length).fill('');

    const vars = {$1desiredVersion: '',
      chosenVersion: ''
    };

    function syncVarsByIndex(i, value) {
      if (i === 0) vars.stackTitle = value;
      if (i === 1) vars.core4 = value;
      if (i === 2) vars.person = value;
      if (i === 3) vars.triggerDesc = value;
      if (i === 4) vars.feelings = value;
      if (i === 11) vars.originalStory = value;
      if (i === 18) vars.whatYouWant = value;
      if (i === 21) vars.meVersion = value;
      if (i === 23) vars.oppositeVersion = value;
      if (i === 25) vars.desiredVersion = value;

      // More robust capture for chosen story
      const q = (questions[i] || '').toLowerCase();
      if (q.includes('which version of the story are you choosing')) {
        vars.chosenVersion = value;
      }
    }

    const labelEl = document.getElementById('question-label');
    const boxEl = document.getElementById('answer-box');
    const nextBtn = document.getElementById('next-btn');
    const backBtn = document.getElementById('back-btn');
    const saveBtn = document.getElementById('save-btn');

    function fillTemplate(raw) {
      return raw
        .replace(/{{person}}/g, vars.person || '[person]')
        .replace(/{{triggerDesc}}/g, vars.triggerDesc || '[trigger description]')
        .replace(/{{feelings}}/g, vars.feelings || '[feelings]')
        .replace(/{{originalStory}}/g, vars.originalStory || '[original story]')
        .replace(/{{whatYouWant}}/g, vars.whatYouWant || '[what you want]')
        .replace(/{{meVersion}}/g, vars.meVersion || '[me version]')
        .replace(/{{oppositeVersion}}/g, vars.oppositeVersion || '[opposite version]')
        .replace(/{{desiredVersion}}/g, vars.desiredVersion || '[desired version]')
        .replace(/{{chosenVersion}}/g, vars.chosenVersion || '[chosen version]');
    }

    function renderQuestion() {
      const q = fillTemplate(questions[current]);
      labelEl.textContent = `Q${current + 1}/${questions.length}: ${q}`;
      boxEl.value = answers[current];
      boxEl.focus();
      backBtn.disabled = current === 0;
      nextBtn.disabled = current === questions.length - 1;
    }

    function persistCurrentAnswer() {
      answers[current] = boxEl.value;
      syncVarsByIndex(current, boxEl.value);
    }

    nextBtn.addEventListener('click', () => {
      persistCurrentAnswer();
      if (current < questions.length - 1) current++;
      renderQuestion();
    });

    backBtn.addEventListener('click', () => {
      persistCurrentAnswer();
      if (current > 0) current--;
      renderQuestion();
    });

    saveBtn.addEventListener('click', () => {
      persistCurrentAnswer();

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'letter' });

      const marginX = 48;
      const pageBottom = 760;
      const contentWidth = 520;
      const lineHeight = 16;

      const title = (vars.stackTitle || 'Untitled').trim();
      const date = new Date().toISOString().split('T')[0];

      // Page 1 (cover)
      let y = 64;
      doc.setFont('Helvetica', 'bold');
      doc.setFontSize(22);
      doc.text('Mega Stack', marginX, y);
      y += 28;

      doc.setFontSize(12);
      doc.text(`Title: ${title}`, marginX, y);
      y += 18;
      doc.text(`Date: ${date}`, marginX, y);
      y += 18;

      if (vars.core4) {
        doc.text(`CORE 4: ${vars.core4}`, marginX, y);
        y += 18;
      }
      if (vars.person) {
        doc.text(`Person: ${vars.person}`, marginX, y);
        y += 18;
      }

      doc.setDrawColor(0);
      doc.line(marginX, y, marginX + contentWidth, y);

      // Start Q&A on Page 2
      doc.addPage();
      y = 64;

      questions.forEach((rawQ, i) => {
        const filledQ = fillTemplate(rawQ);

        doc.setFont('Helvetica', 'bold');
        doc.setFontSize(12);
        const qLines = doc.splitTextToSize(`${i + 1}. ${filledQ}`, contentWidth);
        qLines.forEach(line => {
          if (y > pageBottom) { doc.addPage(); y = 64; }
          doc.text(line, marginX, y);
          y += lineHeight;
        });

        y += 6;
        doc.setFont('Helvetica', 'normal');
        doc.setFontSize(11);
        const aText = (answers[i] || '').toString();
        const aLines = doc.splitTextToSize(aText, contentWidth);

        if (aLines.length === 0) aLines.push('');

        aLines.forEach(line => {
          if (y > pageBottom) { doc.addPage(); y = 64; }
          doc.text(line, marginX, y);
          y += lineHeight;
        });

        y += 14;
      });

      const safeTitle = title.replace(/[^a-zA-Z0-9_-]+/g, '_').slice(0, 50) || 'Untitled';
      doc.save(`mega_stack_${safeTitle}_${date}.pdf`);
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        nextBtn.click();
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'ArrowLeft') {
        e.preventDefault();
        backBtn.click();
      }
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
        e.preventDefault();
        saveBtn.click();
      }
    });

    renderQuestion();
  </script>
</body>
</html>
